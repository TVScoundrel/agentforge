# ST-02002: Implement Type-Safe SELECT Tool

## Story Information
- **Story ID**: ST-02002
- **Epic**: EP-02 (Type-Safe Query Tools)
- **Branch**: `feat/st-02002-type-safe-select-tool`
- **Estimate**: 5 hours
- **Priority**: P0
- **Dependencies**: ST-02001 (Raw SQL Query Execution Tool) -- Merged 2026-02-17

## Description

Implements a type-safe SELECT tool using Drizzle ORM's query builder API. This tool provides a structured, LLM-friendly interface for executing SELECT queries with WHERE conditions, ORDER BY, LIMIT, OFFSET, and column selection across PostgreSQL, MySQL, and SQLite.

## Implementation Approach

The tool uses Drizzle's native `sql` template API directly with a modular folder structure:

- **Schemas** (`schemas.ts`) -- Zod schemas with validation refinements (`.min(1)`, `.superRefine()` for operator/value consistency)
- **Query Builder** (`query-builder.ts`) -- Builds parameterized SQL using `sql` template literals and `sql.join()` for safe parameter binding
- **Identifier Utils** (`identifier-utils.ts`) -- Strict regex validation and vendor-aware quoting (double quotes for PostgreSQL/SQLite, backticks for MySQL)
- **Executor** (`executor.ts`) -- Query execution with sanitized error handling (generic messages for callers, detailed logs server-side)
- **Types** (`types.ts`) -- TypeScript types inferred from Zod schemas
- **Index** (`index.ts`) -- Tool definition using fluent builder API with `connect()`/`disconnect()` lifecycle

## What Changed

### Created (modular structure: `packages/tools/src/data/relational/tools/relational-select/`)
- `schemas.ts` -- Zod input schemas with `.min(1)` validation on table/connectionString/columns and `.superRefine()` enforcing value presence per operator type
- `query-builder.ts` -- SELECT query builder with safe identifier validation/quoting for WHERE, SELECT, ORDER BY, and FROM clauses
- `identifier-utils.ts` -- SQL identifier validation (regex) and vendor-aware quoting helper to prevent SQL injection
- `executor.ts` -- Query executor with sanitized error messages (generic for callers, detailed in logs)
- `types.ts` -- TypeScript type definitions inferred from Zod schemas
- `index.ts` -- Tool definition using fluent builder API

### Created (tests: `packages/tools/tests/data/relational/relational-select/`)
- `schema-validation.test.ts` -- 16 schema validation tests
- `tool-invocation.test.ts` -- 10 tool invocation tests (8 require SQLite bindings)
- `test-utils.ts` -- SQLite binding detection helper
- `index.test.ts` -- Test suite aggregator

### Created (docs)
- `docs/st02002-type-safe-select-tool.md` -- Story documentation

### Modified
- `packages/tools/src/data/relational/tools/index.ts` -- Export new tool
- `planning/kanban-queue.md` -- Story moved to In Review
- `planning/checklists/epic-02-story-tasks.md` -- All checklist items marked complete

## Features Implemented

### WHERE Conditions
Supports all common comparison operators:
- `eq`, `ne` -- Equality/inequality
- `gt`, `lt`, `gte`, `lte` -- Numeric comparisons
- `like` -- Pattern matching
- `in`, `notIn` -- Array membership (properly expanded with `sql.join()`)
- `isNull`, `isNotNull` -- NULL checks

Schema validation enforces:
- Value is required for comparison operators
- Value must not be provided for `isNull`/`isNotNull`
- `in`/`notIn` require non-empty arrays

Multiple WHERE conditions are combined with AND logic.

### ORDER BY
- Support for multiple ORDER BY clauses
- `asc` and `desc` directions
- Column names validated and vendor-quoted

### Pagination
- `LIMIT` -- Maximum number of rows to return (validated as positive integer)
- `OFFSET` -- Number of rows to skip (validated as non-negative integer)

### Column Selection
- Specify array of column names to select
- Omit for `SELECT *`
- Column names validated against injection and vendor-quoted

### Security
- **SQL Injection Prevention**: All identifiers validated with strict regex and vendor-quoted; all values bound using Drizzle's `sql` template tag
- **Vendor-Aware Quoting**: Double quotes for PostgreSQL/SQLite, backticks for MySQL
- **Schema-Qualified Names**: Support for `schema.table` notation (e.g., `public.users`)
- **Error Sanitization**: Generic error messages returned to callers; detailed driver errors logged server-side only
- **Connection Safety**: Uses `connect()`/`disconnect()` lifecycle API with cleanup in `finally` block

### Error Handling
- Sanitized error messages for callers (no driver details leaked)
- Detailed error logging server-side
- Graceful handling of non-existent tables
- Clear validation errors for invalid input (empty table, missing values, invalid operators)

## Testing

### Schema Validation Tests (19 total)
- Valid SELECT query acceptance
- Columns array validation
- WHERE conditions validation
- ORDER BY clauses validation
- LIMIT and OFFSET validation
- Invalid vendor rejection
- Negative limit rejection
- Negative offset rejection
- Empty table name rejection
- Empty connection string rejection
- Value rejected for isNull operator
- Missing value rejected for eq operator
- isNull accepted without value
- Non-array value rejected for IN operator
- Empty array rejected for IN operator
- Empty ORDER BY column name rejection
- Schema-qualified table name acceptance
- Malformed schema-qualified table name rejection

### Tool Invocation Tests (11 total)
- 2 always-run validation tests
- 9 integration tests requiring SQLite bindings
- Empty table name rejection
- Empty connection string rejection
- Simple SELECT query (requires SQLite)
- Non-existent table handling (requires SQLite)
- Column selection (requires SQLite)
- LIMIT application (requires SQLite)
- OFFSET application (requires SQLite)
- LIMIT + OFFSET combination (requires SQLite)
- ORDER BY behavior validation (requires SQLite)
- WHERE filter behavior validation (requires SQLite)
- Schema-qualified table name querying (requires SQLite)

Tests use a real temporary SQLite database file with test data for accurate query testing.

### Full Test Suite Results
- **1118 passed**, 62 skipped
- All relational tests pass (68 passed, 55 skipped across 6 test files)

### Lint Results
- All new code lint-clean

## Acceptance Criteria Coverage

| Criteria | Status |
|---|---|
| Type-safe SELECT with column selection | Done |
| WHERE conditions (eq, ne, gt, lt, like, in, etc.) | Done |
| ORDER BY (asc, desc) | Done |
| LIMIT and OFFSET pagination | Done |
| SQL injection prevention | Done |
| Error handling with sanitized messages | Done |
| Unit tests | Done |
| Story documentation | Done |

## PR Review Comments Addressed

All 15 Copilot review comments addressed in commit `f63e505`:

| # | Category | Fix |
|---|---|---|
| 1-4 | SQL injection via identifiers | Added identifier-utils.ts with strict validation + vendor-aware quoting for WHERE, SELECT, ORDER BY, FROM |
| 5-6 | IN/NOT IN array expansion | Use sql.join() to properly expand arrays |
| 7-9 | Error sanitization | Generic errors for callers, detailed logs server-side, docs updated |
| 10-12 | Schema validation gaps | Added .min(1) and .superRefine() for operator/value enforcement |
| 13-14 | Test issues | Replaced subqueries with real SQLite DB, removed unused imports |
| 15 | Lifecycle API | Switched initialize() to connect()/disconnect() |

## Checklist Progress

- [x] Create branch
- [x] Create draft PR (PR #30)
- [x] Implement SELECT query builder using Drizzle sql template API
- [x] Add WHERE conditions support (all operators)
- [x] Add ORDER BY support (asc/desc)
- [x] Add LIMIT/OFFSET support
- [x] Add column selection support
- [x] Create relational-select tool with fluent builder API
- [x] Define Zod schema with validation refinements
- [x] Implement tool function with connect()/disconnect() lifecycle
- [x] Add type-safe result mapping
- [x] Add error handling with sanitized messages
- [x] Handle empty result sets gracefully
- [x] Export tool from tools/index.ts
- [x] Create unit tests (19 schema + 11 invocation = 30 total)
- [x] Create story documentation
- [x] Run full test suite (1118 passed, 62 skipped)
- [x] Run lint (all clean)
- [x] Address PR review comments (all resolved)
- [x] Mark PR ready for review
- [ ] Wait for merge

## Status
**In Review** -- All implementation complete, review comments addressed, awaiting merge.
